<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>عرض قطعة | لوحة الموظف</title>
  <link rel="stylesheet" href="/assets/styles.css"/>
</head>
<body>
<div class="container">
  <div class="nav">
    <div class="brand">
      <div class="fa-logoWrap" style="position:relative;width:44px;height:44px">
  <div class="logo fa-logoFallback">FA</div>
  <img class="fa-logoImg" src="/assets/logo.png" alt="Fakhr Alanaqah logo"
    style="display:none;width:44px;height:44px;border-radius:14px;object-fit:contain;background:linear-gradient(135deg,var(--gold),#3a2f10);border:1px solid rgba(214,179,94,.35);"/>
</div>
</div>
    <div class="links">
      <a class="pill" href="/staff/">لوحة الموظف</a>
      <a class="pill" href="/">الرئيسية</a>
    </div>
  </div>

  <div class="form" style="margin-top:16px">
    <label>رقم القطعة (SKU)</label>
    <div class="row">
      <input id="sku" placeholder="مثال: B001" style="flex:1;min-width:180px"/>
      <button class="btn primary" id="go">عرض</button>
    </div>
    <div class="small" style="margin-top:8px">ملاحظة: في النسخة النهائية سيكون هذا الدخول محمي بصلاحيات الموظف.</div>
  </div>

  <div id="card" class="hero" style="margin-top:16px;display:none"></div>

  <div class="sectionTitle">تغيير الحالة (تشغيلي)</div>
  <div class="form" id="actions" style="display:none">
    <div class="row">
      <button class="btn" data-st="available">متاحة</button>
      <button class="btn" data-st="rented">مؤجرة</button>
      <button class="btn" data-st="cleaning">في التنظيف</button>
      <button class="btn" data-st="late">تأخير</button>
    </div>
    <div class="small" style="margin-top:10px">غرامة التأخير: 5 ر.ع / يوم (في النسخة النهائية تُحسب تلقائيًا).</div>
  </div>

  <div class="footer">© Fakhr Alanaqah – Demo</div>
</div>

<script src="/assets/config.js"></script>
<script src="/assets/app.js"></script>
<script>
function normSKU(x){
  const s = String(x||'').trim().toUpperCase();
  if(/^[A-Z]{1,2}-\d{3}$/.test(s)) return s.replace('-', '');
  return s;
}

const statusLabels = {
  available: {t:"متاحة", cls:"ok"},
  rented: {t:"مؤجرة", cls:"bad"},
  cleaning: {t:"في التنظيف", cls:""},
  late: {t:"تأخير", cls:"bad"},
};

function getStatus(sku){
  const k = "fa_status_"+sku;
  return localStorage.getItem(k) || "available";
}
function setStatus(sku, st){
  const k = "fa_status_"+sku;
  localStorage.setItem(k, st);
}

(async ()=>{
  const items = await PRODUCTS();
  const skuInput = document.getElementById('sku');
  const btn = document.getElementById('go');
  const card = document.getElementById('card');
  const actions = document.getElementById('actions');

  const initial = q('sku');
  if(initial){ skuInput.value = initial; show(initial); }

  btn.addEventListener('click', ()=> show(skuInput.value));

  async function show(skuRaw){
    const sku = normSKU(skuRaw);
const p = items.find(x=>x.sku===sku);
    if(!p){ alert("لم يتم العثور على SKU. جرّب مثل B001"); return; }
    const st = getStatus(sku);
    const lab = statusLabels[st] || statusLabels.available;

    card.style.display = '';
    actions.style.display = '';
    card.innerHTML = `
      <h2 style="margin:0 0 8px">${p.name} <span style="color:var(--gold)">(${p.sku})</span></h2>
      <div class="badges">
        <span class="badge">البيع: <b style="color:var(--text)">${fmtOMR(p.sale)}</b></span>
        <span class="badge">الإيجار/يوم: <b style="color:var(--text)">${fmtOMR(p.rent_day)}</b></span>
        <span class="badge gold">عربون: ${fmtOMR(p.deposit)}</span>
      </div>
      <p class="notice">الحالة الحالية: <span class="status ${lab.cls}">${lab.t}</span></p>
    `;

    actions.querySelectorAll('button[data-st]').forEach(b=>{
      b.onclick = ()=>{
        const ns = b.getAttribute('data-st');
        setStatus(p.sku, ns);
        show(p.sku);
      };
    });
  }
})();
</script>

<script>
(function(){
  const img = document.getElementById('logoImg');
  const box = document.getElementById('logoBox');
  if(!img) return;
  img.onload = ()=>{ img.style.display='block'; if(box) box.style.display='none'; };
  img.onerror = ()=>{ /* keep fallback */ };
})();
</script>


<script>
(function faInitLogo(){
  const imgs = document.querySelectorAll('.fa-logoImg');
  imgs.forEach(img=>{
    const wrap = img.closest('.fa-logoWrap') || img.parentElement;
    const fallback = wrap ? wrap.querySelector('.fa-logoFallback') : null;
    img.onload = ()=>{ img.style.display='block'; if(fallback) fallback.style.display='none'; };
    img.onerror = ()=>{ /* keep fallback */ };
    // trigger for cached images
    if(img.complete && img.naturalWidth>0){ img.onload(); }
  });
})();
</script>

</body>
</html>