<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>مسح QR | لوحة الموظف</title>
  <link rel="stylesheet" href="/assets/styles.css"/>
</head>
<body>
<div class="container">
  <div class="nav">
    <div class="brand">
      <div class="fa-logoWrap" style="position:relative;width:44px;height:44px">
  <div class="logo fa-logoFallback">FA</div>
  <img class="fa-logoImg" src="/assets/logo.png" alt="Fakhr Alanaqah logo"
    style="display:none;width:44px;height:44px;border-radius:14px;object-fit:contain;background:linear-gradient(135deg,var(--gold),#3a2f10);border:1px solid rgba(214,179,94,.35);"/>
</div>
</div>
    <div class="links">
      <a class="pill" href="/staff/">رجوع</a>
    </div>
  </div>

  <div class="hero">
    <h2 style="margin:0 0 10px">الكاميرا</h2>
    <p class="notice" id="hint">إذا لم يعمل المسح: استخدم "بحث يدوي".</p>
    <div style="margin-top:12px;border:1px solid var(--line);border-radius:18px;overflow:hidden">
      <video id="v" playsinline autoplay style="width:100%;height:auto;display:block;background:black"></video>
    </div>
    <div class="row" style="margin-top:12px">
      <button class="btn primary" id="startBtn">بدء المسح</button>
      <a class="btn" href="/staff/lookup.html">بحث يدوي</a>
    </div>
  </div>

  <div class="footer">© Fakhr Alanaqah – Demo</div>
</div>

<script>
const v = document.getElementById('v');
const hint = document.getElementById('hint');
let stream = null, detector = null, raf = null;

function extractSKU(text){
  // QR could contain SKU directly OR a URL with ?sku=
  try{
    if(!text) return null;
    const raw = String(text).trim();
    let s = raw.toUpperCase();

    // Direct SKU: B003 / KH001
    if(/^[A-Z]{1,2}\d{3}$/.test(s)) return s;

    // Hyphen SKU: B-003 / KH-001
    if(/^[A-Z]{1,2}-\d{3}$/.test(s)) return s.replace('-', '');

    // URL with sku param
    if(raw.includes('sku=') || raw.includes('SKU=')){
      const u = new URL(raw);
      const q = (u.searchParams.get('sku') || u.searchParams.get('SKU') || '').toUpperCase();
      if(/^[A-Z]{1,2}\d{3}$/.test(q)) return q;
      if(/^[A-Z]{1,2}-\d{3}$/.test(q)) return q.replace('-', '');
    }
  }catch(e){}
  return null;
}

async function start(){
  if(!('BarcodeDetector' in window)){
    hint.textContent = "❌ جهازك/متصفحك لا يدعم BarcodeDetector. استخدم البحث اليدوي.";
    return;
  }
  detector = new BarcodeDetector({formats:['qr_code']});
  stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
  v.srcObject = stream;
  hint.textContent = "✅ وجّه الكاميرا على QR...";
  loop();
}

async function loop(){
  try{
    const barcodes = await detector.detect(v);
    if(barcodes && barcodes.length){
      const raw = barcodes[0].rawValue || '';
      const sku = extractSKU(raw);
      if(sku){
        stop();
        location.href = `/staff/lookup.html?sku=${encodeURIComponent(sku)}`;
        return;
      }else{
        hint.textContent = "تم قراءة QR لكن لا يحتوي SKU معروف. جرّب QR آخر.";
      }
    }
  }catch(e){
    hint.textContent = "تعذر المسح. جرّب البحث اليدوي.";
  }
  raf = requestAnimationFrame(loop);
}

function stop(){
  if(raf) cancelAnimationFrame(raf);
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream = null;
  }
}

document.getElementById('startBtn').addEventListener('click', start);
window.addEventListener('beforeunload', stop);
</script>

<script>
(function(){
  const img = document.getElementById('logoImg');
  const box = document.getElementById('logoBox');
  if(!img) return;
  img.onload = ()=>{ img.style.display='block'; if(box) box.style.display='none'; };
  img.onerror = ()=>{ /* keep fallback */ };
})();
</script>


<script>
(function faInitLogo(){
  const imgs = document.querySelectorAll('.fa-logoImg');
  imgs.forEach(img=>{
    const wrap = img.closest('.fa-logoWrap') || img.parentElement;
    const fallback = wrap ? wrap.querySelector('.fa-logoFallback') : null;
    img.onload = ()=>{ img.style.display='block'; if(fallback) fallback.style.display='none'; };
    img.onerror = ()=>{ /* keep fallback */ };
    // trigger for cached images
    if(img.complete && img.naturalWidth>0){ img.onload(); }
  });
})();
</script>

</body>
</html>