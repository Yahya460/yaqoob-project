<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>تفاصيل المنتج | فخر الأناقة (تجريبي)</title>
  <link rel="stylesheet" href="/assets/styles.css"/>
</head>
<body>
  <div class="container">
    <div class="nav">
      <div class="brand">
        <div class="fa-logoWrap" style="position:relative;width:44px;height:44px">
  <div class="logo fa-logoFallback">FA</div>
  <img class="fa-logoImg" src="/assets/logo.png" alt="Fakhr Alanaqah logo"
    style="display:none;width:44px;height:44px;border-radius:14px;object-fit:contain;background:linear-gradient(135deg,var(--gold),#3a2f10);border:1px solid rgba(214,179,94,.35);"/>
</div>
</div>
      <div class="links">
        <a class="pill" href="/">الرئيسية</a>
        <a class="pill" href="/staff/">لوحة الموظف</a>
      </div>
    </div>

    <div id="wrap" class="hero" style="margin-top:18px"></div>

    <div class="sectionTitle">حجز / تأجير (تجريبي)</div>
    <div class="form">
      <div class="split">
        <div>
          <label>المقاس</label>
          <select id="size"></select>
        </div>
        <div>
          <label>نوع الخدمة</label>
          <select id="mode">
            <option value="rent">تأجير</option>
            <option value="buy">شراء</option>
          </select>
        </div>
      </div>

      <div class="split" style="margin-top:12px">
        <div>
          <label>تاريخ الاستلام</label>
          <input id="start" type="date"/>
        </div>
        <div>
          <label>تاريخ الإرجاع (للتأجير)</label>
          <input id="end" type="date"/>
        </div>
      </div>

      <div class="hr"></div>
      <div id="calc" class="notice"></div>

      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="btnFakePay">متابعة (دفع تجريبي)</button>
        <a class="btn" id="btnStaffQR" href="#">QR للموظف</a>
      </div>
      <div class="small" style="margin-top:10px">
        في النسخة التجريبية: زر الدفع يعرض ملخص فقط. الدفع الفعلي يتم لاحقًا بعد ربط بوابة الدفع.
      </div>
    </div>

    <div class="footer">© Fakhr Alanaqah – Demo</div>
  </div>

<script src="/assets/config.js"></script>
<script src="/assets/app.js"></script>
<script>
(async ()=>{
  const sku = q('sku');
  const items = await PRODUCTS();
  const p = items.find(x=>x.sku===sku) || items[0];
  const wrap = document.getElementById('wrap');
  wrap.innerHTML = `
    <h2 style="margin:0 0 8px">${p.name} <span style="color:var(--gold)">(${p.sku})</span></h2>
    <p style="margin:0">البيع: <b style="color:var(--gold)">${fmtOMR(p.sale)}</b> · الإيجار/يوم: <b style="color:var(--gold)">${fmtOMR(p.rent_day)}</b> · العربون: <b style="color:var(--gold)">${fmtOMR(p.deposit)}</b></p>
    <p style="margin:10px 0 0;color:var(--muted)">ملاحظة: الصور مؤقتة الآن. لاحقًا تُرفع صور حقيقية من لوحة يعقوب.</p>
  `;

  // image
  const imgUrl = toImageUrl(p.thumb);
  const imgWrap = document.getElementById('imgWrap');
  if(imgWrap){
    imgWrap.innerHTML = imgUrl
      ? `<div class="card" style="padding:12px;display:flex;gap:12px;align-items:center">
           <div class="thumb" style="width:110px;min-width:110px;height:110px"><img src="${imgUrl}" alt="${p.name}"></div>
           <div>
             <div style="font-weight:800;margin-bottom:6px">صورة المنتج</div>
             <div class="muted" style="font-size:12px">إذا ما ظهرت الصورة: تأكد أن رابط Google Drive على "أي شخص لديه الرابط".</div>
           </div>
         </div>`
      : `<div class="notice">لا توجد صورة لهذا المنتج بعد. أضف رابط صورة من لوحة يعقوب/الموظف.</div>`;
  }

  // sizes
  const sizeSel = document.getElementById('size');
  sizeSel.innerHTML = (p.sizes||[]).map(s=>`<option>${s}</option>`).join('');

  // default dates
  const start = document.getElementById('start');
  const end = document.getElementById('end');
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,'0');
  const dd = String(today.getDate()).padStart(2,'0');
  start.value = `${yyyy}-${mm}-${dd}`;
  const tomorrow = new Date(today.getTime()+24*60*60*1000);
  end.value = `${tomorrow.getFullYear()}-${String(tomorrow.getMonth()+1).padStart(2,'0')}-${String(tomorrow.getDate()).padStart(2,'0')}`;

  const mode = document.getElementById('mode');
  const calc = document.getElementById('calc');
  function recalc(){
    const m = mode.value;
    if(m==='buy'){
      calc.innerHTML = `شراء: تدفع الآن <b style="color:var(--gold)">${fmtOMR(p.sale)}</b> (تجريبي)`;
      end.disabled = true;
      return;
    }
    end.disabled = false;
    const days = daysBetween(start.value, end.value) || 1;
    const total = days * p.rent_day;
    const remaining = Math.max(0, total - p.deposit);
    calc.innerHTML = `
      تأجير يومي: <b style="color:var(--gold)">${days}</b> يوم × <b style="color:var(--gold)">${fmtOMR(p.rent_day)}</b> = <b style="color:var(--gold)">${fmtOMR(total)}</b><br/>
      تدفع الآن عربون: <b style="color:var(--gold)">${fmtOMR(p.deposit)}</b> · المتبقي عند الاستلام: <b style="color:var(--gold)">${fmtOMR(remaining)}</b>
    `;
  }
  [start,end,mode,sizeSel].forEach(el=>el.addEventListener('change',recalc));
  recalc();

  // staff QR link (in real: QR contains sku or url)
  document.getElementById('btnStaffQR').href = `/staff/lookup.html?sku=${encodeURIComponent(p.sku)}`;

  document.getElementById('btnFakePay').addEventListener('click', ()=>{
    alert("✅ تجريبي\n\n" +
      `${p.name} (${p.sku})\n`+
      `الخدمة: ${mode.value==='buy'?'شراء':'تأجير'}\n`+
      `العربون/المبلغ الآن: ${mode.value==='buy'?fmtOMR(p.sale):fmtOMR(p.deposit)}\n`+
      `* الدفع الحقيقي + واتساب سيتم ربطهم لاحقًا`);
  });
})();
</script>

<script>
(function(){
  const img = document.getElementById('logoImg');
  const box = document.getElementById('logoBox');
  if(!img) return;
  img.onload = ()=>{ img.style.display='block'; if(box) box.style.display='none'; };
  img.onerror = ()=>{ /* keep fallback */ };
})();
</script>


<script>
(function faInitLogo(){
  const imgs = document.querySelectorAll('.fa-logoImg');
  imgs.forEach(img=>{
    const wrap = img.closest('.fa-logoWrap') || img.parentElement;
    const fallback = wrap ? wrap.querySelector('.fa-logoFallback') : null;
    img.onload = ()=>{ img.style.display='block'; if(fallback) fallback.style.display='none'; };
    img.onerror = ()=>{ /* keep fallback */ };
    // trigger for cached images
    if(img.complete && img.naturalWidth>0){ img.onload(); }
  });
})();
</script>

</body>
</html>