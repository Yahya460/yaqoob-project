<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>إدارة المنتجات | فخر الأناقة</title>
  <link rel="stylesheet" href="/assets/styles.css"/>
  <style>
    .mini{font-size:12px;color:var(--muted)}
    .tableWrap{margin-top:10px;overflow:auto;border:1px solid rgba(214,179,94,.18);border-radius:18px;background:rgba(0,0,0,.18)}
    table.tbl{width:100%;border-collapse:separate;border-spacing:0}
    .tbl th,.tbl td{padding:10px;border-bottom:1px solid rgba(255,255,255,.06);font-size:13px;vertical-align:middle}
    .tbl thead th{position:sticky;top:0;background:rgba(10,10,10,.92);z-index:2;color:var(--muted);text-align:right}
    .tbl tr:hover td{background:rgba(255,255,255,.03)}
    .thumb{width:44px;height:44px;border-radius:14px;object-fit:cover;border:1px solid rgba(214,179,94,.25);background:#111}
    .badge{display:inline-block;padding:4px 9px;border:1px solid rgba(214,179,94,.25);border-radius:999px;font-size:12px;color:var(--muted)}
    .btnSm{padding:6px 10px;border-radius:12px;font-size:12px}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body>
<div class="container">
  <div class="nav">
    <div class="brand">
      <div class="fa-logoWrap" style="position:relative;width:44px;height:44px">
  <div class="logo fa-logoFallback">FA</div>
  <img class="fa-logoImg" src="/assets/logo.png" alt="Fakhr Alanaqah logo"
    style="display:none;width:44px;height:44px;border-radius:14px;object-fit:contain;background:linear-gradient(135deg,var(--gold),#3a2f10);border:1px solid rgba(214,179,94,.35);"/>
</div>
</div>
    <div class="links">
      <a class="pill" href="/admin/">لوحة يعقوب</a>
            <a class="pill" href="/">الرئيسية</a>
    </div>
  </div>

  <div class="hero" style="margin-top:16px">
    <h2 style="margin:0 0 8px">قبل البدء</h2>
    <p class="notice" style="margin:0">
      لازم تضع رابط الـWeb App مرة واحدة داخل الملف: <b>/assets/config.js</b> ثم ترفع الموقع. بعد الربط، أي إضافة هنا تنحفظ في الشيت فورًا.
    </p>
  </div>

    <div class="split" style="margin-top:12px"><div>
        <label>اختبار الاتصال</label>
        <button class="btn" id="testApi">اختبار</button>
        <div id="testMsg" class="mini"></div>
      </div>
    </div>

  <div class="sectionTitle">إضافة منتج واحد</div>
  <div class="form">
    <div class="split">
      <div>
        <label>SKU (مثال: B201)</label>
        <input id="sku" placeholder="B201" />
      </div>
      <div>
        <label>الاسم</label>
        <input id="name" placeholder="بشت" />
      </div>
    </div>

    <div class="split" style="margin-top:12px">
      <div>
        <label>سعر البيع (ر.ع)</label>
        <input id="sale" type="number" step="0.1" value="50" />
      </div>
      <div>
        <label>سعر الإيجار/يوم (ر.ع)</label>
        <input id="rent" type="number" step="0.1" value="10" />
      </div>
    </div>

    <div class="split" style="margin-top:12px">
      <div>
        <label>العربون (ر.ع)</label>
        <input id="deposit" type="number" step="0.1" value="5" />
      </div>
      <div>
        <label>القسم</label>
        <select id="cat">
          <option>رجال</option>
          <option>نساء</option>
          <option>أولاد</option>
        </select>
      </div>
    </div>

    <div style="margin-top:12px">
      <label>المقاسات (اختياري، افصل بفاصلة)</label>
      <input id="sizes" placeholder="S,M,L,XL" />
      <div class="mini">لو تركتها فاضية نستخدم "مقاس واحد".</div>
    </div>

    <div style="margin-top:12px">
      <label>رابط الصورة (اختياري)</label>
      <div class="split" style="margin-top:8px; gap:8px; align-items:center;">
        <input id="imgFile" type="file" accept="image/*" style="flex:1" />
        <button class="btn" id="uploadImgBtn" type="button">رفع الصورة</button>
        <span class="mini" id="uploadImgStatus"></span>
      </div>
      <input id="imgUrl" placeholder="https://...  أو رابط Google Drive" />
      <div class="mini">لو كنت تستخدم Google Drive: افتح الصورة → مشاركة → (أي شخص لديه الرابط) → انسخ الرابط والصقه هنا. النظام يحوّل الرابط تلقائيًا.</div>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn primary" id="addOne">إضافة</button>
      <span id="m1" class="notice"></span>
    </div>
  </div>

  <div class="sectionTitle">إضافة دفعة بالترقيم</div>
  <div class="form">
    <div class="split">
      <div>
        <label>Prefix</label>
        <select id="prefix">
          <option value="B">B (بشت)</option>
          <option value="K">K (كِمّة)</option>
          <option value="A">A (عصى)</option>
          <option value="KH">KH (خنجر)</option>
        </select>
      </div>
      <div>
        <label>عدد القطع الجديدة</label>
        <input id="count" type="number" value="50" />
      </div>
    </div>

    <div class="split" style="margin-top:12px">
      <div>
        <label>الاسم</label>
        <input id="bName" placeholder="بشت" />
      </div>
      <div>
        <label>رابط صورة (اختياري)</label>
        <input id="bImgUrl" placeholder="https://... أو Google Drive" />
        <div class="mini">سيُستخدم لنفس الدفعة (إذا عندك صورة عامة). للصور المختلفة لكل منتج، أضفها لاحقًا لكل SKU.</div>
      </div>
      <div>
        <label>القسم</label>
        <select id="bCat">
          <option>رجال</option>
          <option>نساء</option>
          <option>أولاد</option>
        </select>
      </div>
    </div>

    <div class="split" style="margin-top:12px">
      <div>
        <label>سعر البيع (ر.ع)</label>
        <input id="bSale" type="number" step="0.1" value="50" />
      </div>
      <div>
        <label>سعر الإيجار/يوم (ر.ع)</label>
        <input id="bRent" type="number" step="0.1" value="10" />
      </div>
    </div>

    <div class="split" style="margin-top:12px">
      <div>
        <label>العربون (ر.ع)</label>
        <input id="bDeposit" type="number" step="0.1" value="5" />
      </div>
      <div>
        <label>المقاسات (اختياري)</label>
        <input id="bSizes" placeholder="S,M,L,XL" />
      </div>
    </div>

    <div class="row" style="margin-top:12px">
      <button class="btn primary" id="addBatch">إضافة الدفعة</button>
      <span id="m2" class="notice"></span>
    </div>
    <div class="mini" style="margin-top:8px">
      النظام يقرأ آخر رقم موجود لهذا الـPrefix داخل الشيت ويبدأ من بعده تلقائيًا (مثال: إذا آخر بشت B100 → يبدأ B101).
    </div>
  </div>

  <div class="sectionTitle">عرض المنتجات</div>
  <div class="form">
    <div class="split">
      <div>
        <label>بحث (بالاسم أو SKU)</label>
        <input id="q" placeholder="مثال: بشت / B201" autocomplete="off" />
      </div>
      <div>
        <label>القسم</label>
        <select id="filterCat">
          <option value="">الكل</option>
          <option value="رجال">رجال</option>
          <option value="نساء">نساء</option>
          <option value="أطفال">أطفال</option>
        </select>
      </div>
    </div>

    <div class="split" style="margin-top:10px">
      <div>
        <label>ترتيب</label>
        <select id="sortBy">
          <option value="new">الأحدث (حسب ترتيب الشيت)</option>
          <option value="sku">SKU</option>
          <option value="name">الاسم</option>
          <option value="sale">سعر البيع</option>
          <option value="rent">سعر الإيجار/يوم</option>
        </select>
      </div>
      <div class="row" style="justify-content:flex-end; gap:8px; align-items:flex-end">
        <button class="btn" id="reload">تحديث</button>
        <button class="btn" id="printLabels" type="button">طباعة ملصقات</button>
        <button class="btn" id="clearFilters">مسح</button>
        <span id="m3" class="notice"></span>
      </div>
    </div>

    <div class="tableWrap" style="margin-top:12px">
      <table class="tbl" id="tbl">
        <thead>
          <tr>
            <th style="width:72px">صورة</th>
            <th>SKU</th>
            <th>الاسم</th>
            <th>القسم</th>
            <th>سعر البيع</th>
            <th>الإيجار/يوم</th>
            <th>العربون</th>
            <th>المقاسات</th>
            <th style="width:90px">إجراء</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="small" id="countInfo" style="margin-top:10px"></div>
  </div>

  <div class="footer">© Fakhr Alanaqah – Demo</div>
</div>

<script src="/assets/config.js"></script>
<script src="/assets/admin-access.js"></script>
<script src="/assets/app.js"></script>
<script>
(function(){
  const img=document.getElementById('logoImg'), box=document.getElementById('logoBox');
  if(img){ img.onload=()=>{img.style.display='block'; if(box) box.style.display='none';}; }
})();

function parseSizes(s){
  const t = String(s||'').trim();
  if(!t) return ["مقاس واحد"];
  return t.split(',').map(x=>x.trim()).filter(Boolean);
}

document.getElementById('addOne').onclick = async ()=>{
  const m1 = document.getElementById('m1');
  m1.textContent = "جارِ الإضافة...";
  try{
    const payload = {
      sku: document.getElementById('sku').value.trim().toUpperCase().replace('-', ''),
      name: document.getElementById('name').value.trim(),
      sale: Number(document.getElementById('sale').value||0),
      rent_day: Number(document.getElementById('rent').value||0),
      deposit: Number(document.getElementById('deposit').value||0),
      cat: document.getElementById('cat').value,
      sizes: parseSizes(document.getElementById('sizes').value),
      thumb: (document.getElementById('imgUrl')?.value||'').trim() || (document.getElementById('sku').value.trim().toUpperCase().match(/^([A-Z]{1,2})/)||[])[1] || ''
    };
    await apiPost('addOne', {...payload});
    m1.textContent = "✅ تمت الإضافة";
  }catch(e){
    m1.textContent = "❌ " + (e.message||e);
  }
};

document.getElementById('addBatch').onclick = async ()=>{
  const m2 = document.getElementById('m2');
  m2.textContent = "جارِ الإضافة...";
  try{
    const payload = {
      prefix: document.getElementById('prefix').value,
      count: Number(document.getElementById('count').value||0),
      name: document.getElementById('bName').value.trim(),
      sale: Number(document.getElementById('bSale').value||0),
      rent_day: Number(document.getElementById('bRent').value||0),
      deposit: Number(document.getElementById('bDeposit').value||0),
      cat: document.getElementById('bCat').value,
      sizes: parseSizes(document.getElementById('bSizes').value),
      thumb: (document.getElementById('imgUrl')?.value||'').trim() || document.getElementById('prefix').value
    };
    const out = await apiPost('addBatch', {...payload});
    m2.textContent = `✅ تمت إضافة ${out.added||0} منتج (من ${out.from||''} إلى ${out.to||''})`;
  }catch(e){
    m2.textContent = "❌ " + (e.message||e);
  }
};

document.getElementById('testApi').onclick = async ()=>{
  const el=document.getElementById('testMsg');
  el.textContent='...';
  try{
    const out = await apiGet('list');
    el.textContent='✅ اتصال ناجح. عدد المنتجات: '+(out.products||[]).length;
  }catch(e){
    el.textContent='❌ '+(e.message||e);
  }
};


// طباعة ملصقات
document.getElementById("printLabels")?.addEventListener("click", ()=>{
  window.open("/admin/labels.html", "_blank");
});

// رفع صورة إلى Google Drive (يتطلب دعم uploadImage في Apps Script)
function fileToDataURL(file){
  return new Promise((resolve,reject)=>{
    const r=new FileReader();
    r.onload=()=>resolve(String(r.result||""));
    r.onerror=()=>reject(r.error||new Error("READ_FAIL"));
    r.readAsDataURL(file);
  });
}
document.getElementById("uploadImgBtn")?.addEventListener("click", async ()=>{
  const st=document.getElementById("uploadImgStatus");
  const f=(document.getElementById("imgFile")||{}).files?.[0];
  if(!f){ if(st) st.textContent="اختر صورة أولاً"; return; }
  if(st) st.textContent="جارِ الرفع...";
  try{
    const dataUrl = await fileToDataURL(f);
    const out = await apiPost("uploadImage", { filename: f.name, dataUrl });
    if(out && out.url){ document.getElementById("imgUrl").value = out.url; }
    if(st) st.textContent= out && out.url ? "✅ تم رفع الصورة" : "تم الرفع";
  }catch(e){
    if(st) st.textContent = "❌ " + (e.message||e);
  }
});

// ===== Products table (view) =====
const __state = { all: [] };

const collator = new Intl.Collator('ar', {numeric:true, sensitivity:'base'});
const $ = (id)=>document.getElementById(id);

function esc(s){
  return String(s ?? '').replace(/[&<>"']/g, ch=>({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[ch]));
}
function isHttp(u){ return /^https?:\/\//i.test(String(u||'')); }

function renderTable(items){
  const tbody = document.querySelector('#tbl tbody');
  if(!tbody) return;
  tbody.innerHTML = items.map(p=>{
    const sku = (p.sku||'').toString();
    const name = (p.name||'').toString();
    const cat = (p.cat||'').toString();
    const sale = Number(p.sale||0);
    const rent = Number(p.rent_day||0);
    const dep = Number(p.deposit||0);
    const sizes = Array.isArray(p.sizes) ? p.sizes.join(', ') : (p.sizes||'');
    const thumb = (p.thumb||'').toString();
    const thumbHtml = thumb
      ? (isHttp(thumb) ? `<img class="thumb" src="${esc(thumb)}" alt="">` : `<span class="badge">${esc(thumb)}</span>`)
      : `<span class="badge">—</span>`;

    return `
      <tr>
        <td class="nowrap">${esc(sku)}</td>
        <td>${thumbHtml}</td>
        <td>${esc(name)}</td>
        <td class="nowrap">${esc(cat||'—')}</td>
        <td class="nowrap">${sale}</td>
        <td class="nowrap">${rent}</td>
        <td class="nowrap">${dep}</td>
        <td>${esc(sizes||'')}</td>
        <td class="nowrap"><button class="btn btnSm" data-copy="${esc(sku)}">نسخ</button></td>
      </tr>`;
  }).join('');
}

function applyFilters(){
  const q = ($('q').value||'').trim().toLowerCase();
  const cat = $('filterCat').value;
  const sortBy = $('sortBy').value;

  let items = (__state.all||[]).slice();
  if(cat) items = items.filter(p=>String(p.cat||'')===cat);
  if(q){
    items = items.filter(p=>{
      const sku = String(p.sku||'').toLowerCase();
      const name = String(p.name||'').toLowerCase();
      return sku.includes(q) || name.includes(q);
    });
  }

  const bySku = (a,b)=>collator.compare(String(a.sku||''), String(b.sku||''));
  const byName = (a,b)=>collator.compare(String(a.name||''), String(b.name||''));
  if(sortBy==='sku_desc') items.sort((a,b)=>-bySku(a,b));
  else if(sortBy==='name_asc') items.sort(byName);
  else if(sortBy==='name_desc') items.sort((a,b)=>-byName(a,b));
  else items.sort(bySku);

  renderTable(items);
  $('countInfo').textContent = `النتيجة: ${items.length} من ${(__state.all||[]).length}`;
}

async function reloadProducts(){
  const m3 = $('m3');
  m3.textContent = 'جارِ التحميل...';
  try{
    __state.all = await PRODUCTS();
    m3.textContent = `✅ تم التحميل (${__state.all.length})`;
  }catch(e){
    __state.all = [];
    m3.textContent = '❌ ' + (e.message||e);
  }
  applyFilters();
}

$('reload').onclick = reloadProducts;
$('clearFilters').onclick = ()=>{ $('q').value=''; $('filterCat').value=''; $('sortBy').value='sku_asc'; applyFilters(); };
$('q').addEventListener('input', ()=>applyFilters());
$('filterCat').addEventListener('change', ()=>applyFilters());
$('sortBy').addEventListener('change', ()=>applyFilters());

document.addEventListener('click', async (ev)=>{
  const btn = ev.target.closest('[data-copy]');
  if(!btn) return;
  const sku = btn.getAttribute('data-copy')||'';
  try{
    await navigator.clipboard.writeText(sku);
    btn.textContent = '✅';
    setTimeout(()=>btn.textContent='نسخ', 900);
  }catch(_){
    // fallback
    prompt('انسخ SKU:', sku);
  }
});

// auto load on open
reloadProducts();
</script>

<script>
(function faInitLogo(){
  const imgs = document.querySelectorAll('.fa-logoImg');
  imgs.forEach(img=>{
    const wrap = img.closest('.fa-logoWrap') || img.parentElement;
    const fallback = wrap ? wrap.querySelector('.fa-logoFallback') : null;
    img.onload = ()=>{ img.style.display='block'; if(fallback) fallback.style.display='none'; };
    img.onerror = ()=>{ /* keep fallback */ };
    // trigger for cached images
    if(img.complete && img.naturalWidth>0){ img.onload(); }
  });
})();
</script>

</body>
</html>