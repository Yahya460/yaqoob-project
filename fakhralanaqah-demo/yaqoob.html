<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>لوحة يعقوب | فخر الأناقة</title>
  <link rel="stylesheet" href="/assets/styles.css"/>
  <style>
    .grid4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    @media(max-width:980px){.grid4{grid-template-columns:repeat(2,minmax(0,1fr));}}
    .kpi{background:rgba(255,255,255,.06);border:1px solid rgba(214,179,94,.25);border-radius:16px;padding:14px}
    .kpi h3{margin:0 0 6px;font-size:13px;color:rgba(255,255,255,.75)}
    .kpi .v{font-size:26px;font-weight:800}
    .muted{color:rgba(255,255,255,.65)}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px;border-bottom:1px solid rgba(214,179,94,.18);text-align:right}
    .pillSmall{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid rgba(214,179,94,.3);background:rgba(0,0,0,.25);font-size:12px}
    .row2{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .input{width:100%;padding:11px 12px;border-radius:12px;border:1px solid rgba(214,179,94,.25);background:rgba(0,0,0,.35);color:#fff}
    .btn2{padding:10px 14px;border-radius:12px;border:1px solid rgba(214,179,94,.35);background:rgba(0,0,0,.35);color:#fff;cursor:pointer}
    .btn2.primary{background:linear-gradient(180deg, rgba(214,179,94,.22), rgba(214,179,94,.10));}
    .warn{padding:12px;border-radius:14px;border:1px dashed rgba(214,179,94,.35);background:rgba(0,0,0,.25)}
  </style>
</head>
<body>
<div class="container">
  <div class="nav">
    <div class="brand">
      <div class="fa-logoWrap" style="position:relative;width:44px;height:44px">
        <div class="logo fa-logoFallback">FA</div>
        <img class="fa-logoImg" src="/assets/logo.png" alt="Fakhr Alanaqah logo"
          style="display:none;width:44px;height:44px;border-radius:14px;object-fit:contain;
          background:linear-gradient(135deg,var(--gold),#3a2f10);border:1px solid rgba(214,179,94,.35);"/>
      </div>
      <div>
        <h1>لوحة يعقوب</h1>
        <small>إحصائيات يومية / شهرية (رمز الدخول: 2025)</small>
      </div>
    </div>
    <div class="links">
      <a class="pill" href="/">الرئيسية</a>
      <a class="pill" href="/admin/products.html">إدارة المنتجات</a>
      <a class="pill" href="/admin/qr.html">طباعة QR</a>
    </div>
  </div>

  <div class="hero" style="margin-top:16px">
    <h2 style="margin:0 0 8px">ملخص سريع</h2>
    <div class="row2">
      <span class="pillSmall" id="todayLbl">اليوم</span>
      <span class="pillSmall" id="monthLbl">هذا الشهر</span>
      <button class="btn2" id="refresh">تحديث</button>
    </div>
    <div id="status" class="muted" style="margin-top:10px"></div>
  </div>

  <div class="sectionTitle">الإحصائيات</div>
  <div class="grid4">
    <div class="kpi"><h3>إيراد اليوم (ر.ع)</h3><div class="v" id="k_today_rev">0</div><div class="muted" id="k_today_break">—</div></div>
    <div class="kpi"><h3>مبيعات اليوم</h3><div class="v" id="k_today_sales">0</div><div class="muted">عدد العمليات</div></div>
    <div class="kpi"><h3>إيجارات اليوم</h3><div class="v" id="k_today_rents">0</div><div class="muted">عدد العمليات</div></div>
    <div class="kpi"><h3>عربون اليوم (ر.ع)</h3><div class="v" id="k_today_dep">0</div><div class="muted">—</div></div>

    <div class="kpi"><h3>إيراد الشهر (ر.ع)</h3><div class="v" id="k_month_rev">0</div><div class="muted" id="k_month_break">—</div></div>
    <div class="kpi"><h3>مبيعات الشهر</h3><div class="v" id="k_month_sales">0</div><div class="muted">عدد العمليات</div></div>
    <div class="kpi"><h3>إيجارات الشهر</h3><div class="v" id="k_month_rents">0</div><div class="muted">عدد العمليات</div></div>
    <div class="kpi"><h3>عربون الشهر (ر.ع)</h3><div class="v" id="k_month_dep">0</div><div class="muted">—</div></div>
  </div>

  <div class="sectionTitle">آخر العمليات</div>
  <div class="form">
    <div id="hint" class="warn">
      <b>تنبيه مهم:</b> الإحصائيات تعتمد على “سجل العمليات”.<br/>
      في النسخة هذه لوحة يعقوب جاهزة، لكن لازم نفعل في Apps Script تبويب جديد اسمه <b>transactions</b> لتسجيل البيع/التأجير والعربون.
      إذا تحب، أضيف لك في التحديث القادم زرَّين في لوحة الموظف لتسجيل العمليات تلقائيًا.
    </div>
    <div style="overflow:auto;margin-top:10px">
      <table class="table" id="txTable">
        <thead><tr>
          <th>الوقت</th><th>النوع</th><th>SKU</th><th>المبلغ</th><th>عربون</th><th>ملاحظة</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="footer">© Fakhr Alanaqah</div>
</div>

<script src="/assets/config.js"></script>
<script src="/assets/app.js"></script>
<script>
(function faInitLogo(){
  const imgs = document.querySelectorAll('.fa-logoImg');
  imgs.forEach(img=>{
    const wrap = img.closest('.fa-logoWrap') || img.parentElement;
    const fallback = wrap ? wrap.querySelector('.fa-logoFallback') : null;
    img.onload = ()=>{ img.style.display='block'; if(fallback) fallback.style.display='none'; };
    if(img.complete && img.naturalWidth>0){ img.onload(); }
  });
})();

// Client-side PIN gate (simple). PIN = 2025 as requested.
const MANAGER_PIN = "2025";
// PIN الخاص بـ Apps Script (لن يظهر إلا ليعقوب)
let SCRIPT_PIN = sessionStorage.getItem('fa_script_pin') || '';
function ensureScriptPin(){
  if(SCRIPT_PIN) return SCRIPT_PIN;
  const p = prompt('أدخل PIN الخاص بالإحصائيات (Apps Script):');
  if(!p) throw new Error('NO_PIN');
  SCRIPT_PIN = String(p);
  sessionStorage.setItem('fa_script_pin', SCRIPT_PIN);
  return SCRIPT_PIN;
}

(function gate(){
  const ok = sessionStorage.getItem('fa_manager_ok') === '1';
  if(ok) return;
  const pin = prompt("أدخل رمز الدخول للوحة يعقوب:");
  if(pin === MANAGER_PIN){
    sessionStorage.setItem('fa_manager_ok','1');
  }else{
    alert("رمز غير صحيح");
    location.href = "/";
  }
})();

function fmt(n){ return (Math.round((Number(n)||0)*100)/100).toFixed(2); }
function setText(id, v){ const el=document.getElementById(id); if(el) el.textContent = v; }

function todayKey(){
  const d=new Date();
  return d.toISOString().slice(0,10); // yyyy-mm-dd
}
function monthKey(){
  const d=new Date();
  return d.toISOString().slice(0,7); // yyyy-mm
}

async function refresh(){
  const status = document.getElementById('status');
  const t = todayKey(), m = monthKey();
  document.getElementById('todayLbl').textContent = "اليوم: " + t;
  document.getElementById('monthLbl').textContent = "الشهر: " + m;
  status.textContent = "جارِ التحميل...";
  try{
    // If API supports summary and transactions list, use it. Otherwise show zeros.
    let summary = null;
    try{ summary = await apiGet('summary', {day:t, month:m, pin: ensureScriptPin()}); }catch(e){ summary=null; }
    if(summary){
      const s = summary.summary || {};
      setText('k_today_rev', fmt(s.today_rev));
      setText('k_today_sales', s.today_sales||0);
      setText('k_today_rents', s.today_rents||0);
      setText('k_today_dep', fmt(s.today_dep));
      setText('k_today_break', `بيع ${fmt(s.today_sale_rev)} / إيجار ${fmt(s.today_rent_rev)}`);
      setText('k_month_rev', fmt(s.month_rev));
      setText('k_month_sales', s.month_sales||0);
      setText('k_month_rents', s.month_rents||0);
      setText('k_month_dep', fmt(s.month_dep));
      setText('k_month_break', `بيع ${fmt(s.month_sale_rev)} / إيجار ${fmt(s.month_rent_rev)}`);
      document.getElementById('hint').style.display='none';
      // load last transactions
      let tx = [];
      try{
        const out = await apiGet('tx', {limit:20, pin: ensureScriptPin()});
        tx = out.transactions || [];
      }catch(e){ tx=[]; }
      const tb=document.querySelector('#txTable tbody');
      tb.innerHTML = tx.map(r=>`
        <tr>
          <td>${r.ts||''}</td>
          <td>${r.type||''}</td>
          <td>${r.sku||''}</td>
          <td>${fmt(r.amount)}</td>
          <td>${fmt(r.deposit)}</td>
          <td>${r.note||''}</td>
        </tr>`).join('');
    }else{
      status.textContent = "⚠️ الإحصائيات تحتاج تفعيل تبويب transactions في Apps Script (الشرح داخل الصفحة).";
    }
    status.textContent = "✅ تم التحديث";
  }catch(e){
    status.textContent = "❌ خطأ: " + (e.message||e);
  }
}

document.getElementById('refresh').onclick = refresh;
refresh();
</script>
</body>
</html>